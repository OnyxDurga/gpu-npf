%info

%variables
RATE={100}
SIZE={256}
THREADS={1, 2, 4, 6, 8}
NDESC={256}

%config
graph_force_diagonal_labels=true
graph_filter_by={AVG-CYCLES:LOSE-RATE}
timeout=60
n_runs=5


%script@smartnic sudo=true
killall -9 click
sleep 3

filename="test.click"

cat > $filename << EOF
FromDPDKDevice(0, NDESC ${NDESC}, MAXTHREADS ${THREADS})
 -> Strip(14)
 -> GetIPAddress(16)
 -> r :: LinearIPLookup()
 -> Unstrip(14)
 -> EtherMirror()
 -> ToDPDKDevice(0, NDESC ${NDESC}, MAXTHREADS ${THREADS});

 s :: Script(
		write r.add 7.0.0.0/8  195.66.224.175 0,
		write r.add 11.0.0.0/8  195.66.224.175 0,
		write r.add 12.0.0.0/8  195.66.224.175 0,
		write r.add 17.0.0.0/8  195.66.226.147 0,
		write r.add 21.0.0.0/8  195.66.224.175 0,
		write r.add 22.0.0.0/8  195.66.224.175 0,
		write r.add 26.0.0.0/8  195.66.224.175 0,
		write r.add 28.0.0.0/8  195.66.224.175 0,
		write r.add 29.0.0.0/8  195.66.224.175 0,
		write r.add 30.0.0.0/8  195.66.224.175 0,
		write r.add 33.0.0.0/8  195.66.224.175 0,
		write r.add 38.0.0.0/8  195.66.224.175 0,
		write r.add 53.0.0.0/8  195.66.224.175 0,
		write r.add 55.0.0.0/8  195.66.224.175 0,
		write r.add 73.0.0.0/8  195.66.224.175 0,
		write r.add 214.0.0.0/8  195.66.224.175 0,
		write r.add 4.0.0.0/9  195.66.224.175 0,
		write r.add 8.0.0.0/9  195.66.224.175 0,
		write r.add 12.0.0.0/9  195.66.224.175 0,
		write r.add 12.128.0.0/9  195.66.224.175 0,
		write r.add 17.0.0.0/9  195.66.226.147 0,
		write r.add 17.128.0.0/9  195.66.226.147 0,
		write r.add 32.0.0.0/9  195.66.224.175 0,
		write r.add 44.0.0.0/9  195.66.224.175 0,
		write r.add 50.128.0.0/9  195.66.224.175 0,
		write r.add 97.128.0.0/9  195.66.224.175 0,
		write r.add 100.128.0.0/9  195.66.224.175 0,
		write r.add 214.128.0.0/9  195.66.224.175 0,
		write r.add 215.0.0.0/9  195.66.224.175 0,
		write r.add 215.128.0.0/9  195.66.224.175 0,
		write r.add 6.192.0.0/10  195.66.224.175 0,
		write r.add 20.64.0.0/10  195.66.224.140 0,
		write r.add 20.192.0.0/10  195.66.224.140 0,
		write r.add 36.128.0.0/10  195.66.224.175 0,
		write r.add 39.128.0.0/10  195.66.224.175 0,
		write r.add 39.192.0.0/10  195.66.224.175 0,
		write r.add 44.128.0.0/10  195.66.224.175 0,
		write r.add 60.64.0.0/10  195.66.224.175 0,
		write r.add 75.192.0.0/10  195.66.224.175 0,
		write r.add 78.192.0.0/10  195.66.224.175 0,
		write r.add 79.192.0.0/10  195.66.224.175 0,
		write r.add 84.128.0.0/10  195.66.224.175 0,
		write r.add 86.128.0.0/10  195.66.224.175 0,
		write r.add 87.128.0.0/10  195.66.224.175 0,
		write r.add 91.0.0.0/10  195.66.224.175 0,
		write r.add 93.192.0.0/10  195.66.224.175 0,
		write r.add 96.128.0.0/10  195.66.224.175 0,
		write r.add 97.0.0.0/10  195.66.224.175 0,
		write r.add 98.192.0.0/10  195.66.224.175 0,
		write r.add 104.64.0.0/10  195.66.224.131 0,
		write r.add 107.64.0.0/10  195.66.224.175 0,
		write r.add 108.192.0.0/10  195.66.224.175 0,
		write r.add 111.0.0.0/10  195.66.224.175 0,
		write r.add 112.0.0.0/10  195.66.224.175 0,
		write r.add 117.128.0.0/10  195.66.224.175 0,
		write r.add 120.192.0.0/10  195.66.224.175 0,
		write r.add 132.0.0.0/10  195.66.224.175 0,
		write r.add 153.128.0.0/10  195.66.224.175 0,
		write r.add 174.192.0.0/10  195.66.224.175 0,
		write r.add 176.128.0.0/10  195.66.224.175 0,
		write r.add 180.0.0.0/10  195.66.224.175 0,
		write r.add 183.0.0.0/10  195.66.224.175 0,
		write r.add 183.192.0.0/10  195.66.224.175 0,
		write r.add 208.192.0.0/10  195.66.224.175 0,
		write r.add 219.0.0.0/10  195.66.224.175 0,
		write r.add 220.0.0.0/10  195.66.224.175 0,
		write r.add 223.64.0.0/10  195.66.227.160 0,
		write r.add 1.128.0.0/11  195.66.224.175 0,
		write r.add 1.224.0.0/11  195.66.224.175 0,
		write r.add 6.160.0.0/11  195.66.224.175 0,
		write r.add 8.224.0.0/11  195.66.224.175 0,
		write r.add 13.64.0.0/11  195.66.224.140 0,
		write r.add 20.0.0.0/11  195.66.224.140 0,
		write r.add 23.32.0.0/11  195.66.224.131 0,
		write r.add 23.192.0.0/11  195.66.224.131 0,
		write r.add 27.192.0.0/11  195.66.224.175 0,
		write r.add 31.64.0.0/11  195.66.225.253 0,
		write r.add 31.96.0.0/11  195.66.225.253 0,
		write r.add 31.224.0.0/11  195.66.224.175 0,
		write r.add 34.32.0.0/11  195.66.224.125 0,
		write r.add 34.64.0.0/11  195.66.224.125 0,
		write r.add 39.32.0.0/11  195.66.224.21 0,
		write r.add 39.64.0.0/11  195.66.224.175 0,
		write r.add 44.192.0.0/11  195.66.224.175 0,
		write r.add 44.224.0.0/11  195.66.224.175 0,
		write r.add 49.64.0.0/11  195.66.224.175 0,
		write r.add 52.160.0.0/11  195.66.224.140 0,
		write r.add 52.224.0.0/11  195.66.224.140 0,
		write r.add 59.0.0.0/11  195.66.224.21 0,
		write r.add 60.128.0.0/11  195.66.224.175 0,
		write r.add 65.128.0.0/11  195.66.224.175 0,
		write r.add 65.192.0.0/11  195.66.224.175 0,
		write r.add 67.160.0.0/11  195.66.224.175 0,
		write r.add 68.32.0.0/11  195.66.224.175 0,
		write r.add 70.160.0.0/11  195.66.224.131 0,
		write r.add 70.192.0.0/11  195.66.224.175 0,
		write r.add 71.96.0.0/11  195.66.224.175 0,
		write r.add 72.96.0.0/11  195.66.224.175 0,
		write r.add 72.192.0.0/11  195.66.224.131 0,
		write r.add 76.96.0.0/11  195.66.224.175 0,
		write r.add 76.128.0.0/11  195.66.224.175 0,
		write r.add 78.160.0.0/11  195.66.224.175 0,
		write r.add 78.192.0.0/11  195.66.224.175 0,
		write r.add 78.224.0.0/11  195.66.224.175 0,
		write r.add 80.128.0.0/11  195.66.224.175 0,
		write r.add 81.128.0.0/11  195.66.224.175 0,
		write r.add 82.0.0.0/11  195.66.224.175 0,
		write r.add 82.224.0.0/11  195.66.224.175 0,
		write r.add 83.0.0.0/11  195.66.224.175 0,
		write r.add 86.0.0.0/11  195.66.224.175 0,
		write r.add 86.128.0.0/11  195.66.224.175 0,
		write r.add 88.160.0.0/11  195.66.224.175 0,
		write r.add 88.224.0.0/11  195.66.224.175 0,
		write r.add 90.192.0.0/11  195.66.225.234 0,
		write r.add 92.0.0.0/11  195.66.224.136 0,
		write r.add 93.0.0.0/11  195.66.224.175 0,
		write r.add 96.64.0.0/11  195.66.224.175 0,
		write r.add 96.192.0.0/11  195.66.224.175 0,
		write r.add 98.32.0.0/11  195.66.224.175 0,
		write r.add 98.160.0.0/11  195.66.224.175 0,
		write r.add 99.224.0.0/11  195.66.224.175 0,
		write r.add 101.160.0.0/11  195.66.224.175 0,
		write r.add 105.128.0.0/11  195.66.224.175 0,
		write r.add 106.128.0.0/11  195.66.224.175 0,
		write r.add 108.64.0.0/11  195.66.224.175 0,
		write r.add 109.0.0.0/11  195.66.224.175 0,
		write r.add 112.224.0.0/11  195.66.224.175 0,
		write r.add 113.64.0.0/11  195.66.224.175 0,
		write r.add 114.160.0.0/11  195.66.224.175 0,
		write r.add 115.192.0.0/11  195.66.224.175 0,
		write r.add 120.96.0.0/11  195.66.224.175 0,
		write r.add 120.160.0.0/11  195.66.224.175 0,
		write r.add 121.128.0.0/11  195.66.224.175 0,
		write r.add 121.160.0.0/11  195.66.224.21 0,
		write r.add 125.128.0.0/11  195.66.224.175 0,
		write r.add 131.32.0.0/11  195.66.224.175 0,
		write r.add 132.96.0.0/11  195.66.224.175 0,
		write r.add 136.32.0.0/11  195.66.224.21 0,
		write r.add 153.192.0.0/11  195.66.224.175 0,
		write r.add 156.160.0.0/11  195.66.224.175 0,
		write r.add 156.192.0.0/11  195.66.224.175 0,
		write r.add 162.160.0.0/11  195.66.224.175 0,
		write r.add 171.224.0.0/11  195.66.224.175 0,
		write r.add 172.32.0.0/11  195.66.224.175 0,
		write r.add 172.128.0.0/11  195.66.224.140 0,
		write r.add 172.160.0.0/11  195.66.224.140 0,
		write r.add 174.160.0.0/11  195.66.224.175 0,
		write r.add 180.96.0.0/11  195.66.224.175 0,
		write r.add 183.128.0.0/11  195.66.224.175 0,
		write r.add 196.128.0.0/11  195.66.224.131 0,
		write r.add 197.0.0.0/11  195.66.224.175 0,
		write r.add 197.32.0.0/11  195.66.224.175 0,
		write r.add 205.0.0.0/11  195.66.224.175 0,
		write r.add 205.64.0.0/11  195.66.224.175 0,
		write r.add 208.0.0.0/11  195.66.225.35 0,
		write r.add 215.32.0.0/11  195.66.224.175 0,
		write r.add 215.96.0.0/11  195.66.224.175 0,
		write r.add 217.224.0.0/11  195.66.224.175 0,
		write r.add 221.32.0.0/11  195.66.224.175 0,
		write r.add 221.64.0.0/11  195.66.224.175 0,
		write r.add 223.32.0.0/11  195.66.224.175 0,
		write r.add 223.64.0.0/11  195.66.224.175 0,
		write r.add 1.160.0.0/12  195.66.224.175 0,
		write r.add 1.208.0.0/12  195.66.224.175 0,
		write r.add 2.160.0.0/12  195.66.224.175 0,
		write r.add 2.176.0.0/12  195.66.226.48 0,
		write r.add 3.64.0.0/12  195.66.225.175 0,
		write r.add 3.80.0.0/12  195.66.224.175 0,
		write r.add 3.208.0.0/12  195.66.224.175 0,
		write r.add 3.224.0.0/12  195.66.224.175 0,
		write r.add 4.144.0.0/12  195.66.224.140 0,
		write r.add 4.160.0.0/12  195.66.224.140 0,
		write r.add 4.176.0.0/12  195.66.224.140 0,
		write r.add 4.192.0.0/12  195.66.224.140 0,
		write r.add 4.208.0.0/12  195.66.224.140 0,
		write r.add 4.224.0.0/12  195.66.224.140 0,
		write r.add 4.240.0.0/12  195.66.224.140 0,
		write r.add 6.96.0.0/12  195.66.224.175 0,
		write r.add 6.144.0.0/12  195.66.224.175 0,
		write r.add 8.0.0.0/12  195.66.224.175 0,
		write r.add 8.16.0.0/12  195.66.224.175 0,
		write r.add 8.32.0.0/12  195.66.224.175 0,
		write r.add 8.48.0.0/12  195.66.224.175 0,
		write r.add 8.64.0.0/12  195.66.224.175 0,
		write r.add 8.192.0.0/12  195.66.224.175 0,
		write r.add 8.224.0.0/12  195.66.224.175 0,
		write r.add 8.240.0.0/12  195.66.224.175 0,
		write r.add 14.16.0.0/12  195.66.224.175 0,
		write r.add 14.64.0.0/12  195.66.224.21 0,
		write r.add 14.80.0.0/12  195.66.224.175 0,
		write r.add 14.112.0.0/12  195.66.224.175 0,
		write r.add 14.144.0.0/12  195.66.224.175 0,
		write r.add 14.208.0.0/12  195.66.224.175 0,
		write r.add 17.160.0.0/12  195.66.226.145 0,
		write r.add 20.48.0.0/12  195.66.224.140 0,
		write r.add 20.160.0.0/12  195.66.224.140 0,
		write r.add 23.0.0.0/12  195.66.224.131 0,
		write r.add 23.112.0.0/12  195.66.224.175 0,
		write r.add 24.0.0.0/12  195.66.224.175 0,
		write r.add 27.16.0.0/12  195.66.224.175 0,
		write r.add 27.64.0.0/12  195.66.224.175 0,
		write r.add 27.160.0.0/12  195.66.224.175 0,
		write r.add 32.128.0.0/12  195.66.224.175 0,
		write r.add 32.208.0.0/12  195.66.224.175 0,
		write r.add 34.16.0.0/12  195.66.224.125 0,
		write r.add 34.64.0.0/12  195.66.224.125 0,
		write r.add 34.80.0.0/12  195.66.224.125 0,
		write r.add 34.96.0.0/12  195.66.224.125 0,
		write r.add 34.192.0.0/12  195.66.224.175 0,
		write r.add 34.208.0.0/12  195.66.224.175 0,
		write r.add 34.224.0.0/12  195.66.224.175 0,
		write r.add 35.80.0.0/12  195.66.224.175 0,
		write r.add 36.16.0.0/12  195.66.224.175 0,
		write r.add 37.80.0.0/12  195.66.224.175 0,
		write r.add 37.160.0.0/12  195.66.224.175 0,
		write r.add 39.112.0.0/12  195.66.224.175 0,
		write r.add 40.0.0.0/12  195.66.224.31 0,
		write r.add 40.80.0.0/12  195.66.224.140 0,
		write r.add 41.32.0.0/12  195.66.224.175 0,
		write r.add 41.96.0.0/12  195.66.224.175 0,
		write r.add 41.112.0.0/12  195.66.224.18 0,
		write r.add 41.160.0.0/12  195.66.224.175 0,
		write r.add 42.16.0.0/12  195.66.224.175 0,
		write r.add 42.32.0.0/12  195.66.224.175 0,
		write r.add 42.224.0.0/12  195.66.224.175 0,
		write r.add 43.16.0.0/12  195.66.224.175 0,
		write r.add 43.32.0.0/12  195.66.224.175 0,
		write r.add 43.48.0.0/12  195.66.224.175 0,
		write r.add 45.16.0.0/12  195.66.224.175 0,
		write r.add 46.80.0.0/12  195.66.224.175 0,
		write r.add 47.144.0.0/12  195.66.224.175 0,
		write r.add 47.160.0.0/12  195.66.224.175 0,
		write r.add 47.208.0.0/12  195.66.224.175 0,
		write r.add 48.192.0.0/12  195.66.224.140 0,
		write r.add 49.160.0.0/12  195.66.224.175 0,
		write r.add 49.176.0.0/12  195.66.224.175 0,
		write r.add 52.96.0.0/12  195.66.224.140 0,
		write r.add 57.112.0.0/12  195.66.226.147 0,
		write r.add 57.160.0.0/12  195.66.224.140 0,
		write r.add 58.160.0.0/12  195.66.224.175 0,
		write r.add 58.192.0.0/12  195.66.224.21 0,
		write r.add 58.208.0.0/12  195.66.224.175 0,
		write r.add 58.224.0.0/12  195.66.224.175 0,
		write r.add 59.0.0.0/12  195.66.224.21 0,
		write r.add 59.16.0.0/12  195.66.224.21 0,
		write r.add 59.64.0.0/12  195.66.224.21 0,
		write r.add 60.32.0.0/12  195.66.224.175 0,
		write r.add 60.176.0.0/12  195.66.224.175 0,
		write r.add 63.0.0.0/12  195.66.224.175 0,
		write r.add 63.16.0.0/12  195.66.224.175 0,
		write r.add 63.48.0.0/12  195.66.224.175 0,
		write r.add 63.64.0.0/12  195.66.224.175 0,
		write r.add 63.80.0.0/12  195.66.224.175 0,
		write r.add 63.96.0.0/12  195.66.224.175 0,
		write r.add 63.112.0.0/12  195.66.224.175 0,
		write r.add 63.144.0.0/12  195.66.224.175 0,
		write r.add 63.160.0.0/12  195.66.225.35 0,
		write r.add 63.192.0.0/12  195.66.224.175 0,
		write r.add 63.224.0.0/12  195.66.224.175 0,
		write r.add 0.0.0.0/0  195.66.224.175 0,
)
EOF

sudo /home/ubuntu/fastclick_dpu/bin/click --dpdk -c 0xff -n 4 --file-prefix npf -- test.click


%script@joyeux sudo=true delay=12

export LD_LIBRARY_PATH=/etinfo/users/2021/rvanhauwaert/dpdk-23.03/dpdk/install/lib/x86_64-linux-gnu/:$LD_LIBRARY_PATH
sudo LD_LIBRARY_PATH=$LD_LIBRARY_PATH /etinfo/users/2021/rvanhauwaert/dpdk-23.03/Pktgen-DPDK/usr/local/bin/pktgen -l 0-7 -n 4 -a 0000:01:00.1 --file-prefix npf -- -m [1/2/3:4/5/6].0 -P -f cfg.lua


%file cfg.lua
package.path = package.path .. ";/etinfo/users/2021/rvanhauwaert/yeah/Pktgen-DPDK/?.lua"
require("Pktgen")


-- Set random seed
math.randomseed(os.time())

local first_byte = math.random(1, 255)
local second_byte = math.random(1, 255)
local third_byte = math.random(1, 255)
local dstip = 1234
-- Generate a random source IP address
local first_byte = math.random(1, 255)
local second_byte = math.random(1, 255)
local third_byte = math.random(1, 255)
local fourth_byte = math.random(1, 255)
local srcip = 4321
-- Writting packet length in dstmac field (60 bytes packets)
local dstmac = "00:00:3C:00:00:00"
local srcmac = "04:3f:72:dc:4a:65"
--  3c:ec:ef:97:ee:90 joyeux

-- =================== Generic Info ===================
pktgen.ports_per_page(1)

pktgen.range.dst_mac("all", "start", dstmac)
pktgen.range.src_mac("all", "start", srcmac)

pktgen.set_range("all", "on")

pktgen.range.src_ip("all", "start", "1.1.1.1")
pktgen.range.src_ip("all", "min", "0.0.0.0")
pktgen.range.src_ip("all", "inc", "0.0.0.1")
pktgen.range.src_ip("all", "max", "255.255.255.255")

-- For some reason, the simple start statement does not work
-- I had to set min, max to the same value and increment to 0
pktgen.range.dst_ip("all", "start", "1.1.1.1")
pktgen.range.dst_ip("all", "min", "0.0.0.0")
pktgen.range.dst_ip("all", "inc", "0.0.0.1")
pktgen.range.dst_ip("all", "max", "255.255.255.255")

pktgen.range.ip_proto("all", "tcp")

pktgen.range.pkt_size("all", "start", 64)
pktgen.range.pkt_size("all", "inc", 0)
pktgen.range.pkt_size("all", "min", 64)
pktgen.range.pkt_size("all", "max", 64)

pktgen.range.dst_port("0", "start", 1024)
pktgen.range.dst_port("0", "inc", 1)
pktgen.range.dst_port("0", "min", 1024)
pktgen.range.dst_port("0", "max", 1500)

-- Source port iterates over the list of ports
pktgen.range.src_port("0", "start", 2048)
pktgen.range.src_port("0", "inc", 1)
pktgen.range.src_port("0", "min", 2048)
pktgen.range.src_port("0", "max", 2048)

-- Set the rate to 20%
-- pktgen.set("all", "rate", ${RATE})
-- pktgen.set("all", "count", 30000000)

-- Settings latency stuff
pktgen.latency(0, "enable");
pktgen.latency(0, "rate", 1000);
pktgen.latency(0, "entropy", 12);
pktgen.latency(0, "enable");
pktgen.latency(0, "rate", 10000);
pktgen.latency(0, "entropy", 8);

pktgen.delay(100)
pktgen.start("all")

pktgen.delay(15000)

pktgen.stop("0")

statRx = pktgen.portStats(0, "port")[0]
pkt_stats = pktgen.pktStats(0)
avg_cycles = pkt_stats[0].latency.avg_cycles
num_rx = statRx.ipackets
num_tx = statRx.opackets
mbits_rx = pktgen.portStats("all", "rate")[0].mbits_rx
print("\n\n RESULT-RX-NB-PKT " .. num_rx / 15 .. "\n\n")
print("\n\n RESULT-RX-RATE " .. num_rx / 15 * 8 * 64 / 1000000000 .. "\n\n")
print("\n\n RESULT-LOSE-RATE " .. 1-(num_rx / (num_tx)) .. "\n\n")

pktgen.quit()